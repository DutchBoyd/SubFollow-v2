<html>
<head>
  <meta charset="utf-8">
  <title>Sub Follow</title>
  <script src="/jquery.min.js"></script>

  <script src="/twitch.js"></script>

  <script>
    window.CLIENT_ID = 'kee5ygdwscdgp0qyo9sm9lszqghqu8x';

    $(function() {
      // Initialize. If we are already logged in, there is no
      // need for the connect button
      Twitch.init({
        clientId: CLIENT_ID,
        redirect_uri: 'http://www.subfollow.com/example.html'
      }, function(error, status) {
        if (status.authenticated) {
          // we're logged in :)
          $('.status input').val('Logged in! Allowed scope: ' + status.scope);
          // Show the data for logged-in users
          $('.authenticated').removeClass('hidden');
        } else {
          $('.status input').val('Not Logged in! Better connect with Twitch!');
          // Show the twitch connect button
          $('.authenticate').removeClass('hidden');
        }
      });

      // Logging in to Twitch
      $('.twitch-connect').click(function() {
        Twitch.login({
          scope: ['user_read', 'channel_read', 'user_follows_edit', 'channel_subscriptions']
        });

      })

      // Logging out of Twitch
      $('#logout button').click(function() {
        Twitch.logout();

        // Reload page and reset url hash. You shouldn't
        // need to do this.
        window.location = window.location.pathname
      })

      // declaring ourUser variable
      var ourUser;
      var user_names = [];
      var subscription;


      $('#get-the-subs button').click(function() {
          Twitch.api({method: 'user'}, function(error, user) {
          ourUser = user.display_name;
        });

          Twitch.api({method: '/channels/DutchBoyd/subscriptions', params: {limit: 100, offset: 500}}, function(error, subResponse) {
          $('#get-sub-count input').val(subResponse._total);
          console.log(subResponse);
          
          // iterating over the subscriptions objects and pulling the subscribed usernames into an array
          for (var i = 0; i < subResponse.subscriptions.length; i++) {
            subscription = subResponse.subscriptions[i];
            user_names.push(subscription.user.name);

          }
          console.log(user_names);

        });
      })


      $('#follow-your-subs button').click(function() {

        var targetUser;

        for (var i = 0; i < user_names.length; i++) {

        targetUser = user_names[i];
        Twitch.api({method: 'users/' + ourUser + '/follows/channels/' + targetUser, verb: 'PUT' }, function(error, response){
          if(typeof error !== 'undefined'){
            console.log(error);
          }
        });

      }
    });
  });

  </script>

  <style type="text/css">
  .hidden {
    display: none;
  }
  </style>
</head>
<body>
  <h1><a href=/>Sub Follow App</a></h1>
    <div class="status">
      Status: <input readonly="readonly" size="60" val="Unknown"/>
    </div>
    <div class="authenticate hidden">
      <img src="http://ttv-api.s3.amazonaws.com/assets/connect_dark.png" class="twitch-connect" href="#" />
    </div>

    <h2 class="authenticated hidden">Authenticated</h2>
    <div class="authenticated hidden">
      <div id="logout">
        <button>Log Out</button>
      </div>

      <div id="get-the-subs">
        <button>Get Your Subscribers</button>
        <input readonly="readonly" size="50" value="Unknown"/>
      </div>

      <div id="follow-your-subs">
        <br><br>
        <button>Follow Your Subs!</button>
      </div>


    </div>
</body>
</html>